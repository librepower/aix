#!/opt/freeware/bin/bash
#
# google-authenticator-setup - Easy 2FA Setup for AIX
# LibrePower (https://librepower.org)
#

VERSION="1.2"
GA_BIN="/opt/freeware/bin/google-authenticator"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

banner() {
    echo ""
    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║     2FA SETUP - Google Authenticator for AIX                 ║"
    echo "║                                                              ║"
    echo "║     LibrePower - https://librepower.org                      ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo ""
}

check_ntp() {
    echo -e "${BLUE}[1/4] Checking time synchronization...${NC}"

    NTP_RUNNING=0
    NTP_SYNCED=0
    OFFSET=""
    OFFSET_MS=0

    # Check if xntpd is running
    if lssrc -s xntpd 2>/dev/null | grep -q "active"; then
        NTP_RUNNING=1
    elif ps -ef 2>/dev/null | grep -v grep | grep -q "xntpd"; then
        NTP_RUNNING=1
    fi

    # Check if actually synchronized (has a selected peer marked with * or +)
    if [[ $NTP_RUNNING -eq 1 ]]; then
        NTP_OUTPUT=$(ntpq -p 2>/dev/null)
        if echo "$NTP_OUTPUT" | grep -q "^[\*\+]"; then
            NTP_SYNCED=1
            # Get offset from the selected peer (line starting with *)
            OFFSET=$(echo "$NTP_OUTPUT" | grep "^\*" | awk '{print $9}' | tr -d '-')
            if [[ -z "$OFFSET" ]]; then
                # Try backup peer (line starting with +)
                OFFSET=$(echo "$NTP_OUTPUT" | grep "^\+" | head -1 | awk '{print $9}' | tr -d '-')
            fi
        fi
    fi

    # Evaluate status
    if [[ $NTP_RUNNING -eq 0 ]]; then
        echo -e "${YELLOW}⚠ WARNING: NTP service (xntpd) is not running!${NC}"
        echo "  TOTP codes require synchronized time."
        echo "  Run: startsrc -s xntpd"
        echo ""
        echo -n "Continue anyway? (y/n): "
        read -r resp
        case "$resp" in
            [yY]) ;;
            *) exit 1 ;;
        esac
    elif [[ $NTP_SYNCED -eq 0 ]]; then
        echo -e "${YELLOW}⚠ WARNING: xntpd is running but NOT synchronized!${NC}"
        echo "  No NTP server configured or reachable."
        echo "  Check /etc/ntp.conf and verify network connectivity."
        echo "  TOTP codes may fail if time is not accurate."
        echo ""
        echo -n "Continue anyway? (y/n): "
        read -r resp
        case "$resp" in
            [yY]) ;;
            *) exit 1 ;;
        esac
    else
        # NTP is running and synchronized - check offset
        if [[ -n "$OFFSET" ]] && [[ "$OFFSET" =~ ^[0-9]+\.?[0-9]*$ ]]; then
            # Convert to integer for comparison (remove decimal part)
            OFFSET_MS=${OFFSET%.*}
            OFFSET_MS=${OFFSET_MS:-0}

            if [[ $OFFSET_MS -gt 30000 ]]; then
                # Offset > 30 seconds - critical for TOTP
                echo -e "${RED}✗ CRITICAL: Time offset is ${OFFSET}ms (>30 seconds)!${NC}"
                echo "  TOTP uses 30-second windows. Codes WILL fail."
                echo "  Wait for NTP to synchronize or check your NTP config."
                echo ""
                echo -n "Continue anyway? (y/n): "
                read -r resp
                case "$resp" in
                    [yY]) ;;
                    *) exit 1 ;;
                esac
            elif [[ $OFFSET_MS -gt 5000 ]]; then
                # Offset > 5 seconds - warning
                echo -e "${YELLOW}⚠ NTP synchronized but offset is ${OFFSET}ms (>5 seconds)${NC}"
                echo "  This may cause occasional TOTP failures."
                echo -e "${GREEN}✓ Continuing (offset should improve over time)${NC}"
            else
                # Offset OK
                echo -e "${GREEN}✓ NTP synchronized (offset: ${OFFSET}ms)${NC}"
            fi
        else
            echo -e "${GREEN}✓ NTP synchronized${NC}"
        fi
    fi
    echo ""
}

check_existing() {
    echo -e "${BLUE}[2/4] Checking existing configuration...${NC}"
    
    if [[ -f "$HOME/.google_authenticator" ]]; then
        echo -e "${YELLOW}⚠ You already have 2FA configured!${NC}"
        echo "  File: $HOME/.google_authenticator"
        echo ""
        echo -n "Overwrite and create new configuration? (y/n): "
        read -r resp
        case "$resp" in
            [yY]) ;;
            *) 
                echo "Keeping existing configuration."
                exit 0 
                ;;
        esac
    else
        echo -e "${GREEN}✓ No existing configuration found${NC}"
    fi
    echo ""
}

get_issuer() {
    echo -e "${BLUE}[3/4] Configuration...${NC}"
    
    HOSTNAME=$(hostname -s 2>/dev/null || echo "AIX-Server")
    USERNAME=$(whoami)
    
    echo "Your organization name (shown in authenticator app):"
    echo -n "  [Default: LibrePower]: "
    read -r ORG
    ORG="${ORG:-LibrePower}"
    
    ISSUER="$ORG"
    LABEL="${USERNAME}@${HOSTNAME}"
    echo ""
    echo "  App will show: $ISSUER ($LABEL)"
    echo ""
}

run_setup() {
    echo -e "${BLUE}[4/4] Generating secret key and QR code...${NC}"
    echo ""
    
    "$GA_BIN" -t -d -f -w 17 -r 3 -R 30 -Q UTF8 -l "$LABEL" -i "$ISSUER"
    
    RC=$?
    echo ""
    
    if [[ $RC -eq 0 ]]; then
        echo "╔══════════════════════════════════════════════════════════════╗"
        echo -e "║  ${GREEN}✓ 2FA CONFIGURED SUCCESSFULLY!${NC}                              ║"
        echo "╠══════════════════════════════════════════════════════════════╣"
        echo "║  IMPORTANT:                                                  ║"
        echo "║  • Save the emergency codes in a safe place                  ║"
        echo "║  • Test login from another terminal before closing this one  ║"
        echo "║  • HMC console never asks for 2FA (emergency access)         ║"
        echo "╚══════════════════════════════════════════════════════════════╝"
    else
        echo -e "${RED}✗ Setup failed. Check errors above.${NC}"
    fi
}

show_help() {
    echo "google-authenticator-setup v$VERSION"
    echo "Easy 2FA setup for AIX"
    echo ""
    echo "Usage: google-authenticator-setup [options]"
    echo ""
    echo "Options:"
    echo "  -h, --help     Show this help"
    echo "  -v, --version  Show version"
    echo ""
    echo "Spanish version: google-authenticator-configura"
    echo ""
    echo "https://librepower.org"
}

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -v|--version)
            echo "google-authenticator-setup v$VERSION"
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done

if [[ $(id -u) -eq 0 ]]; then
    echo -e "${YELLOW}⚠ Running as root. 2FA will be configured for root user.${NC}"
    echo "For regular users, run this command as that user."
    echo ""
fi

if [[ ! -x "$GA_BIN" ]]; then
    echo -e "${RED}✗ Error: google-authenticator not found at $GA_BIN${NC}"
    echo "Install with: rpm -ivh google-authenticator-*.rpm"
    exit 1
fi

banner
check_ntp
check_existing
get_issuer
run_setup
