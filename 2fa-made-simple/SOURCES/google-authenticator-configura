#!/opt/freeware/bin/bash
#
# google-authenticator-configura - Configuración fácil de 2FA para AIX
# LibrePower (https://librepower.org)
#

VERSION="1.2"
GA_BIN="/opt/freeware/bin/google-authenticator"

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

banner() {
    echo ""
    echo "╔══════════════════════════════════════════════════════════════╗"
    echo "║     CONFIGURACION 2FA - Google Authenticator para AIX        ║"
    echo "║                                                              ║"
    echo "║     LibrePower - https://librepower.org                      ║"
    echo "╚══════════════════════════════════════════════════════════════╝"
    echo ""
}

check_ntp() {
    echo -e "${BLUE}[1/4] Verificando sincronización de hora...${NC}"

    NTP_RUNNING=0
    NTP_SYNCED=0
    OFFSET=""
    OFFSET_MS=0

    # Verificar si xntpd está corriendo
    if lssrc -s xntpd 2>/dev/null | grep -q "active"; then
        NTP_RUNNING=1
    elif ps -ef 2>/dev/null | grep -v grep | grep -q "xntpd"; then
        NTP_RUNNING=1
    fi

    # Verificar si realmente está sincronizado (tiene peer seleccionado con * o +)
    if [[ $NTP_RUNNING -eq 1 ]]; then
        NTP_OUTPUT=$(ntpq -p 2>/dev/null)
        if echo "$NTP_OUTPUT" | grep -q "^[\*\+]"; then
            NTP_SYNCED=1
            # Obtener offset del peer seleccionado (línea que empieza con *)
            OFFSET=$(echo "$NTP_OUTPUT" | grep "^\*" | awk '{print $9}' | tr -d '-')
            if [[ -z "$OFFSET" ]]; then
                # Intentar peer de respaldo (línea que empieza con +)
                OFFSET=$(echo "$NTP_OUTPUT" | grep "^\+" | head -1 | awk '{print $9}' | tr -d '-')
            fi
        fi
    fi

    # Evaluar estado
    if [[ $NTP_RUNNING -eq 0 ]]; then
        echo -e "${YELLOW}⚠ ADVERTENCIA: El servicio NTP (xntpd) no está corriendo!${NC}"
        echo "  Los códigos TOTP requieren hora sincronizada."
        echo "  Ejecuta: startsrc -s xntpd"
        echo ""
        echo -n "¿Continuar de todos modos? (s/n): "
        read -r resp
        case "$resp" in
            [sS]) ;;
            *) exit 1 ;;
        esac
    elif [[ $NTP_SYNCED -eq 0 ]]; then
        echo -e "${YELLOW}⚠ ADVERTENCIA: xntpd está corriendo pero NO sincronizado!${NC}"
        echo "  No hay servidor NTP configurado o alcanzable."
        echo "  Revisa /etc/ntp.conf y verifica conectividad de red."
        echo "  Los códigos TOTP pueden fallar si la hora no es precisa."
        echo ""
        echo -n "¿Continuar de todos modos? (s/n): "
        read -r resp
        case "$resp" in
            [sS]) ;;
            *) exit 1 ;;
        esac
    else
        # NTP corriendo y sincronizado - verificar offset
        if [[ -n "$OFFSET" ]] && [[ "$OFFSET" =~ ^[0-9]+\.?[0-9]*$ ]]; then
            # Convertir a entero para comparación (quitar parte decimal)
            OFFSET_MS=${OFFSET%.*}
            OFFSET_MS=${OFFSET_MS:-0}

            if [[ $OFFSET_MS -gt 30000 ]]; then
                # Offset > 30 segundos - crítico para TOTP
                echo -e "${RED}✗ CRÍTICO: El desfase de tiempo es ${OFFSET}ms (>30 segundos)!${NC}"
                echo "  TOTP usa ventanas de 30 segundos. Los códigos FALLARÁN."
                echo "  Espera a que NTP sincronice o revisa tu configuración."
                echo ""
                echo -n "¿Continuar de todos modos? (s/n): "
                read -r resp
                case "$resp" in
                    [sS]) ;;
                    *) exit 1 ;;
                esac
            elif [[ $OFFSET_MS -gt 5000 ]]; then
                # Offset > 5 segundos - advertencia
                echo -e "${YELLOW}⚠ NTP sincronizado pero desfase de ${OFFSET}ms (>5 segundos)${NC}"
                echo "  Esto puede causar fallos ocasionales de TOTP."
                echo -e "${GREEN}✓ Continuando (el desfase debería mejorar con el tiempo)${NC}"
            else
                # Offset OK
                echo -e "${GREEN}✓ NTP sincronizado (desfase: ${OFFSET}ms)${NC}"
            fi
        else
            echo -e "${GREEN}✓ NTP sincronizado${NC}"
        fi
    fi
    echo ""
}

check_existing() {
    echo -e "${BLUE}[2/4] Verificando configuración existente...${NC}"
    
    if [[ -f "$HOME/.google_authenticator" ]]; then
        echo -e "${YELLOW}⚠ ¡Ya tienes 2FA configurado!${NC}"
        echo "  Archivo: $HOME/.google_authenticator"
        echo ""
        echo -n "¿Sobrescribir y crear nueva configuración? (s/n): "
        read -r resp
        case "$resp" in
            [sS]) ;;
            *) 
                echo "Manteniendo configuración existente."
                exit 0 
                ;;
        esac
    else
        echo -e "${GREEN}✓ No se encontró configuración previa${NC}"
    fi
    echo ""
}

get_issuer() {
    echo -e "${BLUE}[3/4] Configuración...${NC}"
    
    HOSTNAME=$(hostname -s 2>/dev/null || echo "AIX-Server")
    USERNAME=$(whoami)
    
    echo "Nombre de tu organización (se muestra en la app):"
    echo -n "  [Por defecto: LibrePower]: "
    read -r ORG
    ORG="${ORG:-LibrePower}"
    
    ISSUER="$ORG"
    LABEL="${USERNAME}@${HOSTNAME}"
    echo ""
    echo "  En la app verás: $ISSUER ($LABEL)"
    echo ""
}

run_setup() {
    echo -e "${BLUE}[4/4] Generando clave secreta y código QR...${NC}"
    echo ""
    
    "$GA_BIN" -t -d -f -w 17 -r 3 -R 30 -Q UTF8 -l "$LABEL" -i "$ISSUER"
    
    RC=$?
    echo ""
    
    if [[ $RC -eq 0 ]]; then
        echo "╔══════════════════════════════════════════════════════════════╗"
        echo -e "║  ${GREEN}✓ ¡2FA CONFIGURADO CORRECTAMENTE!${NC}                           ║"
        echo "╠══════════════════════════════════════════════════════════════╣"
        echo "║  IMPORTANTE:                                                 ║"
        echo "║  • Guarda los códigos de emergencia en lugar seguro          ║"
        echo "║  • Prueba login en otra terminal antes de cerrar esta        ║"
        echo "║  • La consola HMC nunca pide 2FA (acceso de emergencia)      ║"
        echo "╚══════════════════════════════════════════════════════════════╝"
    else
        echo -e "${RED}✗ Falló la configuración. Revisa los errores.${NC}"
    fi
}

show_help() {
    echo "google-authenticator-configura v$VERSION"
    echo "Configuración fácil de 2FA para AIX"
    echo ""
    echo "Uso: google-authenticator-configura [opciones]"
    echo ""
    echo "Opciones:"
    echo "  -h, --help     Muestra esta ayuda"
    echo "  -v, --version  Muestra la versión"
    echo ""
    echo "Versión en inglés: google-authenticator-setup"
    echo ""
    echo "https://librepower.org"
}

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help|--ayuda)
            show_help
            exit 0
            ;;
        -v|--version)
            echo "google-authenticator-configura v$VERSION"
            exit 0
            ;;
        *)
            echo "Opción desconocida: $1"
            show_help
            exit 1
            ;;
    esac
done

if [[ $(id -u) -eq 0 ]]; then
    echo -e "${YELLOW}⚠ Ejecutando como root. 2FA se configurará para root.${NC}"
    echo "Para usuarios normales, ejecuta como ese usuario."
    echo ""
fi

if [[ ! -x "$GA_BIN" ]]; then
    echo -e "${RED}✗ Error: google-authenticator no encontrado en $GA_BIN${NC}"
    echo "Instala con: rpm -ivh google-authenticator-*.rpm"
    exit 1
fi

banner
check_ntp
check_existing
get_issuer
run_setup
