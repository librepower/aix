================================================================================
  GOOGLE AUTHENTICATOR 2FA PARA AIX/VIOS
  Autenticación de Doble Factor (TOTP)
  
  SIXE - IBM Business Partner
  https://sixe.eu | hugo.blanco@sixe.eu
  
  LibrePower - https://librepower.org
================================================================================

CONTENIDO DEL PAQUETE
---------------------
- google-authenticator-1.10-1.aix7.1.ppc.rpm     (Oficial IBM AIX Toolbox)
- libqrencode-4.1.1-4.librepower.aix7.3.ppc.rpm        (Librería de códigos QR)
- google-authenticator-setup-1.0-4.librepower.aix7.3.ppc.rpm       (Asistentes de configuración)

El paquete de asistentes incluye:
  - google-authenticator-setup      (Asistente en inglés)
  - google-authenticator-configura  (Asistente en español)

NOTA IMPORTANTE
---------------
Los RPMs solo instalan los binarios. La configuración de PAM y SSH es MANUAL
para evitar bloqueos accidentales. El 2FA NO se activa hasta completar los
pasos 2 y 3. Puedes instalar los RPMs de forma segura sin afectar el acceso
actual al sistema.

DESCARGA
--------
# Descargar con curl (usar -L para seguir redirecciones)
cd /tmp

curl -L -o libqrencode-4.1.1-4.librepower.aix7.3.ppc.rpm \
  https://github.com/librepower/aix/releases/download/2fa-v1.0/libqrencode-4.1.1-4.librepower.aix7.3.ppc.rpm

curl -L -o google-authenticator-1.10-1.aix7.1.ppc.rpm \
  https://github.com/librepower/aix/releases/download/2fa-v1.0/google-authenticator-1.10-1.aix7.1.ppc.rpm

curl -L -o google-authenticator-setup-1.0-4.librepower.aix7.3.ppc.rpm \
  https://github.com/librepower/aix/releases/download/2fa-v1.0/google-authenticator-setup-1.0-4.librepower.aix7.3.ppc.rpm

# Verificar descargas (debe mostrar "RPM v3.0", NO "HTML")
file *.rpm

REQUISITOS
----------
- AIX 7.1+ o VIOS 3.x
- NTP configurado y sincronizado (¡CRÍTICO!)
- Acceso root para instalación

PASO 0: CONFIGURAR NTP (MUY IMPORTANTE)
---------------------------------------
Los códigos TOTP se basan en el tiempo. Si el reloj del servidor difiere más
de 30 segundos, la autenticación FALLARÁ. Configura NTP antes de configurar 2FA.

# Crear configuración NTP
cat > /etc/ntp.conf << 'NTPEOF'
# Configuración NTP
driftfile /etc/ntp.drift

# Servidores NTP públicos
server 0.pool.ntp.org iburst
server 1.pool.ntp.org iburst
server 2.pool.ntp.org iburst
server time.google.com iburst

# Restricciones
restrict default limited kod nomodify notrap nopeer noquery
restrict 127.0.0.1
NTPEOF

# Sincronizar hora inmediatamente
ntpdate -u pool.ntp.org

# Iniciar daemon NTP
startsrc -s xntpd

# Habilitar en el arranque: edita /etc/rc.tcpip y descomenta la entrada xntpd:
# Start up Network Time Protocol (NTP) daemon
# start /usr/sbin/xntpd "$src_running"

# Verificar sincronización
ntpq -p

PASO 1: INSTALAR RPMs (como root)
---------------------------------
cd /tmp
rpm -ivh libqrencode-4.1.1-4.librepower.aix7.3.ppc.rpm
rpm -ivh google-authenticator-1.10-1.aix7.1.ppc.rpm
rpm -ivh google-authenticator-setup-1.0-4.librepower.aix7.3.ppc.rpm

PASO 2: CONFIGURAR PAM (como root)
----------------------------------
Añade al final de /etc/pam.conf:

# SSH 2FA for AIX made SIMPLE
sshd    auth       required   pam_aix
sshd    auth       required   /usr/lib/security/pam_google_authenticator.so nullok no_increment_hotp
sshd    account    required   pam_aix
sshd    password   required   pam_aix
sshd    session    required   pam_aix

Nota: "nullok" permite que usuarios SIN 2FA configurado puedan seguir entrando.
Elimina "nullok" después para obligar 2FA a todos los usuarios.

PASO 3: CONFIGURAR SSH (como root)
----------------------------------
Añade a /etc/ssh/sshd_config:

# SSH 2FA for AIX made SIMPLE
UsePAM yes
KbdInteractiveAuthentication yes

Reinicia SSH:
stopsrc -s sshd
startsrc -s sshd

NOTA: Después de este paso, 2FA está ACTIVO para SSH. Los usuarios con
~/.google_authenticator necesitarán contraseña + código. Los usuarios
sin él solo necesitarán contraseña (nullok).

PASO 4: CONFIGURAR 2FA POR USUARIO
----------------------------------
Cada usuario debe configurar su propio 2FA. Entra como el usuario (o su - usuario).

OPCIÓN A: Usar el Asistente Fácil (RECOMENDADO)

  google-authenticator-configura       # Español
  # O
  google-authenticator-setup           # English (Inglés)

El asistente:
  - Verifica la sincronización NTP
  - Pregunta el nombre del emisor (empresa/servidor)
  - Genera clave secreta y código QR
  - Guarda la configuración automáticamente

OPCIÓN B: Comando Manual

  google-authenticator -t -d -f -w 17 -r 3 -R 30 -Q UTF8 -i "TuEmpresa"

Parámetros explicados:
  -t           Basado en tiempo (TOTP)
  -d           No permitir reutilizar códigos
  -f           Forzar escritura (no preguntar si guardar)
  -w 17        Tamaño de ventana (permite ~8 min desfase)
  -r 3 -R 30   Límite: 3 intentos por 30 segundos
  -Q UTF8      Mostrar código QR en terminal
  -i "Nombre"  Nombre del emisor mostrado en la app

ESCANEA EL CÓDIGO QR con Google Authenticator, Microsoft Authenticator, Authy, etc.

GUARDA LOS CÓDIGOS DE EMERGENCIA en un lugar seguro (caja fuerte, gestor de contraseñas).

PASO 5: PROBAR ANTES DE CERRAR TU SESIÓN
----------------------------------------
¡CRÍTICO! Abre un NUEVO terminal y prueba el login SSH antes de cerrar tu sesión.

Desde otro terminal:
  ssh usuario@servidor

Deberías ver:
  Password: (introduce tu contraseña)
  Verification code: (introduce el código de 6 dígitos de la app)

Si funciona, has terminado. Si no, todavía tienes tu sesión original abierta.

ACCESO DE EMERGENCIA
--------------------
Si te quedas bloqueado:
1. Consola HMC: La consola serie NUNCA pide 2FA (acceso de emergencia)
2. Códigos de emergencia: Usa uno de tus scratch codes en lugar del código de la app
3. Eliminar 2FA: Borra /home/usuario/.google_authenticator

INSTRUCCIONES DE ROLLBACK
-------------------------
Si algo sale mal:

1. Como root, comenta la línea pam_google_authenticator en /etc/pam.conf:
   # sshd    auth       required   /usr/lib/security/pam_google_authenticator.so nullok

2. Reinicia SSH:
   stopsrc -s sshd
   startsrc -s sshd

3. Eliminar 2FA de un usuario:
   rm /home/usuario/.google_authenticator

DESPLIEGUE GRADUAL
------------------
Para despliegue empresarial:
1. Instala los RPMs en todos los servidores (seguro, sin impacto)
2. Configura PAM y SSH con la opción "nullok"
3. Los usuarios configuran 2FA uno a uno
4. Cuando todos tengan 2FA, elimina "nullok" para obligar

SOLUCIÓN DE PROBLEMAS
---------------------
Problema: Los códigos no funcionan
  - Verifica NTP: ntpq -p (el desfase debe ser < 30 seg)
  - Verifica zona horaria: date (debe coincidir con la hora real)
  - Resincronizar: ntpdate -u pool.ntp.org

Problema: El código QR no se muestra
  - Asegúrate de que libqrencode está instalado: rpm -qa | grep qrencode
  - El terminal debe soportar UTF-8

Problema: "sudo" no funciona después de configurar
  - Probablemente cambiaste auth_type en /etc/security/login.cfg
  - Cámbialo de vuelta a STD_AUTH (NO PAM_AUTH)

VERSIÓN
-------
Versión de documentación: 1.9 (Enero 2026)

================================================================================
  SIXE - IBM Business Partner | https://sixe.eu
  LibrePower | https://librepower.org
================================================================================
