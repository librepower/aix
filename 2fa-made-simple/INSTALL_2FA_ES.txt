================================================================================
  GOOGLE AUTHENTICATOR 2FA PARA AIX/VIOS
  Autenticación de Dos Factores (TOTP)
  
  SIXE - IBM Business Partner
  https://sixe.eu | hugo.blanco@sixe.eu
================================================================================

CONTENIDO DEL PAQUETE
---------------------
- google-authenticator-1.10-1.aix7.1.ppc.rpm  (Paquete oficial IBM AIX Toolbox)
- libqrencode-4.1.1-4.aix7.3.sixe.ppc.rpm     (Librería QR para consola)
- 2fa-check                                    (Script opcional de aviso en login)

NOTA IMPORTANTE
---------------
Los RPMs solo instalan los binarios. La configuración de PAM y SSH es MANUAL
para evitar bloqueos accidentales. 2FA NO se activa hasta completar los
pasos 2 y 3. Puedes instalar los RPMs de forma segura sin afectar el acceso
actual al sistema.

Acceso de emergencia: La consola serie (tty desde HMC) NO usa SSH, por lo que
nunca pedirá 2FA. Siempre podrás recuperar el acceso desde la consola HMC.


PREREQUISITOS
-------------
1. AIX 7.1 o superior / VIOS 3.x
2. Acceso root (en VIOS: oem_setup_env)
3. **CRÍTICO: SINCRONIZACIÓN DE RELOJ (NTP)**
   TOTP requiere que el reloj del servidor esté sincronizado.
   Una diferencia de más de 30 segundos causará fallos de autenticación.


DESCARGAR RPMs
--------------
Descarga los RPMs directamente desde GitHub Releases usando curl:

cd /tmp

curl -L -o libqrencode-4.1.1-4.aix7.3.sixe.ppc.rpm \
  https://github.com/librepower/aix/releases/download/2fa-v1.0/libqrencode-4.1.1-4.aix7.3.sixe.ppc.rpm

curl -L -o google-authenticator-1.10-1.aix7.1.ppc.rpm \
  https://github.com/librepower/aix/releases/download/2fa-v1.0/google-authenticator-1.10-1.aix7.1.ppc.rpm

Verificar que las descargas son archivos RPM válidos:
  file *.rpm
  # Debe mostrar: RPM v3.0 bin...

NOTA: El flag -L es necesario para seguir las redirecciones de GitHub.
      NO descargues desde URLs /blob/ - esas devuelven páginas HTML, no binarios.


PASO 0: CONFIGURAR NTP (MUY IMPORTANTE)
---------------------------------------
Verificar hora actual:
  date
  ntpdate -q pool.ntp.org

Si hay diferencia significativa (>30 seg), sincronizar:

# Configuración NTP
cat > /etc/ntp.conf << 'NTPEOF'
# NTP Configuration
driftfile /etc/ntp.drift

# Servidores NTP públicos
server 0.pool.ntp.org iburst
server 1.pool.ntp.org iburst
server 2.pool.ntp.org iburst
server time.google.com iburst

# Restricciones
restrict default limited kod nomodify notrap nopeer noquery
restrict 127.0.0.1
NTPEOF

ntpdate -u pool.ntp.org
startsrc -s xntpd
ntpq -p

# Para que arranque automáticamente edita /etc/rc.tcpip u descomenta la entrada de NTP

# Start up Network Time Protocol (NTP) daemon
start /usr/sbin/xntpd "$src_running"

PASO 1: INSTALACIÓN DE RPMs (como root)
---------------------------------------
# En VIOS, primero entrar en modo root:
oem_setup_env

cd /tmp
rpm -ivh libqrencode-4.1.1-4.aix7.3.sixe.ppc.rpm
rpm -ivh google-authenticator-1.10-1.aix7.1.ppc.rpm

NOTA: Después de este paso, 2FA aún NO está activo. El acceso actual no se ve afectado.


PASO 2: CONFIGURAR PAM (como root)
----------------------------------
Añadir al final de /etc/pam.conf:

sshd    auth       required   pam_aix
sshd    auth       required   /usr/lib/security/pam_google_authenticator.so nullok no_increment_hotp
sshd    account    required   pam_aix
sshd    password   required   pam_aix
sshd    session    required   pam_aix

NOTA: "nullok" permite que usuarios SIN 2FA entren solo con password.


PASO 3: CONFIGURAR SSH (como root)
----------------------------------
Añadir a /etc/ssh/sshd_config:

UsePAM yes
KbdInteractiveAuthentication yes

Reiniciar SSH:
stopsrc -s sshd
startsrc -s sshd

NOTA: Después de este paso, 2FA está ACTIVO para SSH. Los usuarios con
~/.google_authenticator necesitarán password + código. Los que no lo tengan
solo necesitarán password (nullok).


PASO 4: CONFIGURAR 2FA POR USUARIO
----------------------------------
Cada usuario que quiera 2FA ejecuta:

google-authenticator -t -d -w 17 -r 3 -R 30 -i "NombreEmpresa"

O interactivamente:

google-authenticator -t -i "NombreEmpresa"

Escanea el código QR con tu app (Google Authenticator, Microsoft Authenticator, etc.)
Guarda los códigos de emergencia (scratch codes) en un lugar seguro.


PASO 5 (OPCIONAL): AVISO AUTOMÁTICO DE 2FA EN LOGIN
----------------------------------------------------
Para avisar a usuarios sin 2FA que lo activen al hacer login, crear el script
y añadirlo a /etc/profile:

# Crear el script:
cat > /opt/freeware/bin/2fa-check << 'SCRIPTEOF'
#!/bin/bash
[ "$(id -u)" = "0" ] && return 2>/dev/null
[ -f "$HOME/.google_authenticator" ] && return 2>/dev/null
case $- in *i*) ;; *) return 2>/dev/null ;; esac

echo ""
echo "╔════════════════════════════════════════════════════════════╗"
echo "║   AUTENTICACIÓN DE DOS FACTORES (2FA) DISPONIBLE           ║"
echo "╚════════════════════════════════════════════════════════════╝"
echo "  Tu cuenta no tiene 2FA activado."
echo "  Esto añade una capa extra de seguridad a tu acceso."
echo ""
printf "  ¿Activar ahora? (s/n): "
read -r resp

case "$resp" in
    [sS])
        if [ -x /opt/freeware/bin/google-authenticator ]; then
            echo ""
            /opt/freeware/bin/google-authenticator -t -d -w 17 -r 3 -R 30 -i "$(hostname -s)"
        else
            echo "Error: google-authenticator no encontrado"
        fi
        ;;
    *)
        echo ""
        echo "  Puedes activarlo más tarde ejecutando:"
        echo "    google-authenticator -t -i NombreEmpresa"
        echo ""
        ;;
esac
SCRIPTEOF
chmod +x /opt/freeware/bin/2fa-check

# Habilitar en /etc/profile:
echo '[ -x /opt/freeware/bin/2fa-check ] && . /opt/freeware/bin/2fa-check' >> /etc/profile

Para desactivar: eliminar la línea de /etc/profile.


VERIFICACIÓN
------------
Desde otra terminal (no cerrar la sesión actual):

ssh usuario@servidor

Debe pedir:
1. Password
2. Verification code (6 dígitos de la app)


DESACTIVAR 2FA PARA UN USUARIO
------------------------------
rm ~/.google_authenticator


ROLLBACK COMPLETO
-----------------
grep -v "pam_google_authenticator" /etc/pam.conf > /tmp/pam.tmp
mv /tmp/pam.tmp /etc/pam.conf
stopsrc -s sshd
startsrc -s sshd


SOLUCIÓN DE PROBLEMAS
---------------------
1. Código no funciona: Verificar NTP (date; ntpq -p)
2. Usuario bloqueado: chuser "account_locked=false" usuario
3. SSH falla: Hacer rollback y verificar /etc/pam.conf


SOPORTE
-------
SIXE - IBM Business Partner
hugo.blanco@sixe.eu | https://sixe.eu

================================================================================
  Versión: 1.7 | Enero 2026
================================================================================
