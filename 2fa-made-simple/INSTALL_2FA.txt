================================================================================
  GOOGLE AUTHENTICATOR 2FA FOR AIX/VIOS
  Two-Factor Authentication (TOTP)
  
  SIXE - IBM Business Partner
  https://sixe.eu | hugo.blanco@sixe.eu
  
  LibrePower - https://librepower.org
================================================================================

PACKAGE CONTENTS
----------------
- google-authenticator-1.10-1.aix7.1.ppc.rpm     (Official IBM AIX Toolbox)
- libqrencode-4.1.1-4.aix7.3.sixe.ppc.rpm        (QR code library)
- google-authenticator-setup-1.0-2.ppc.rpm       (Easy setup wizards)

The setup wizards package includes:
  - google-authenticator-setup      (English wizard)
  - google-authenticator-configura  (Spanish wizard)

IMPORTANT NOTE
--------------
The RPMs only install the binaries. PAM and SSH configuration is MANUAL
to prevent accidental lockouts. 2FA is NOT activated until you complete
steps 2 and 3. You can install the RPMs safely without affecting current
access to the system.

DOWNLOAD
--------
# Download with curl (use -L to follow redirects)
cd /tmp

curl -L -o libqrencode-4.1.1-4.aix7.3.sixe.ppc.rpm \
  https://github.com/librepower/aix/releases/download/2fa-v1.0/libqrencode-4.1.1-4.aix7.3.sixe.ppc.rpm

curl -L -o google-authenticator-1.10-1.aix7.1.ppc.rpm \
  https://github.com/librepower/aix/releases/download/2fa-v1.0/google-authenticator-1.10-1.aix7.1.ppc.rpm

curl -L -o google-authenticator-setup-1.0-2.aix7.3.librepower.ppc.rpm \
  https://github.com/librepower/aix/releases/download/2fa-v1.0/google-authenticator-setup-1.0-2.aix7.3.librepower.ppc.rpm

# Verify downloads (must show "RPM v3.0", NOT "HTML")
file *.rpm

REQUIREMENTS
------------
- AIX 7.1+ or VIOS 3.x
- NTP configured and synchronized (CRITICAL!)
- Root access for installation

STEP 0: CONFIGURE NTP (VERY IMPORTANT)
--------------------------------------
TOTP codes are time-based. If your server clock is off by more than 30 seconds,
authentication will FAIL. Configure NTP before setting up 2FA.

# Create NTP configuration
cat > /etc/ntp.conf << 'NTPEOF'
# NTP Configuration
driftfile /etc/ntp.drift

# Public NTP servers
server 0.pool.ntp.org iburst
server 1.pool.ntp.org iburst
server 2.pool.ntp.org iburst
server time.google.com iburst

# Restrictions
restrict default limited kod nomodify notrap nopeer noquery
restrict 127.0.0.1
NTPEOF

# Sync time immediately
ntpdate -u pool.ntp.org

# Start NTP daemon
startsrc -s xntpd

# Enable at boot: edit /etc/rc.tcpip and uncomment the xntpd entry:
# Start up Network Time Protocol (NTP) daemon
# start /usr/sbin/xntpd "$src_running"

# Verify synchronization
ntpq -p

STEP 1: INSTALL RPMs (as root)
------------------------------
cd /tmp
rpm -ivh libqrencode-4.1.1-4.aix7.3.sixe.ppc.rpm
rpm -ivh google-authenticator-1.10-1.aix7.1.ppc.rpm
rpm -ivh google-authenticator-setup-1.0-2.aix7.3.librepower.ppc.rpm

STEP 2: CONFIGURE PAM (as root)
-------------------------------
Add to the end of /etc/pam.conf:

# SSH 2FA for AIX made SIMPLE
sshd    auth       required   pam_aix
sshd    auth       required   /usr/lib/security/pam_google_authenticator.so nullok no_increment_hotp
sshd    account    required   pam_aix
sshd    password   required   pam_aix
sshd    session    required   pam_aix

Note: "nullok" allows users WITHOUT 2FA configured to still login normally.
Remove "nullok" later to enforce 2FA for all users.

STEP 3: CONFIGURE SSH (as root)
-------------------------------
Add to /etc/ssh/sshd_config:

# SSH 2FA for AIX made SIMPLE
UsePAM yes
KbdInteractiveAuthentication yes

Restart SSH:
stopsrc -s sshd
startsrc -s sshd

NOTE: After this step, 2FA is ACTIVE for SSH. Users with ~/.google_authenticator
will need password + code. Users without it will only need password (nullok).

STEP 4: CONFIGURE 2FA PER USER
------------------------------
Each user must configure their own 2FA. Login as the user (or su - username).

OPTION A: Use the Easy Wizard (RECOMMENDED)

  google-authenticator-setup           # English
  # OR
  google-authenticator-configura       # Spanish (EspaÃ±ol)

The wizard will:
  - Check NTP synchronization
  - Ask for issuer name (company/server name)
  - Generate secret key and QR code
  - Save configuration automatically

OPTION B: Manual Command

  google-authenticator -t -d -f -w 17 -r 3 -R 30 -Q UTF8 -i "YourCompany"

Parameters explained:
  -t           Time-based (TOTP)
  -d           Disallow reuse of codes
  -f           Force write (don't ask to save)
  -w 17        Window size (allows ~8 min clock skew)
  -r 3 -R 30   Rate limit: 3 attempts per 30 seconds
  -Q UTF8      Show QR code in terminal
  -i "Name"    Issuer name shown in app

SCAN THE QR CODE with Google Authenticator, Microsoft Authenticator, Authy, etc.

SAVE THE EMERGENCY SCRATCH CODES in a secure place (safe, password manager).

STEP 5: TEST BEFORE CLOSING YOUR SESSION
-----------------------------------------
CRITICAL: Open a NEW terminal and test SSH login before closing your session!

From another terminal:
  ssh user@server

You should see:
  Password: (enter your password)
  Verification code: (enter 6-digit code from app)

If it works, you're done. If not, you still have your original session open.

EMERGENCY ACCESS
----------------
If you get locked out:
1. HMC Console: Serial console NEVER asks for 2FA (emergency access)
2. Emergency codes: Use one of your scratch codes instead of app code
3. Remove 2FA: Delete /home/username/.google_authenticator

ROLLBACK INSTRUCTIONS
---------------------
If something goes wrong:

1. As root, comment out the pam_google_authenticator line in /etc/pam.conf:
   # sshd    auth       required   /usr/lib/security/pam_google_authenticator.so nullok

2. Restart SSH:
   stopsrc -s sshd
   startsrc -s sshd

3. Remove 2FA for a user:
   rm /home/username/.google_authenticator

GRADUAL ROLLOUT
---------------
For enterprise deployment:
1. Install RPMs on all servers (safe, no impact)
2. Configure PAM and SSH with "nullok" option
3. Have users configure 2FA one by one
4. Once all users have 2FA, remove "nullok" to enforce

TROUBLESHOOTING
---------------
Problem: Codes don't work
  - Check NTP: ntpq -p (offset should be < 30 sec)
  - Verify timezone: date (must match real time)
  - Resync: ntpdate -u pool.ntp.org

Problem: QR code not showing
  - Ensure libqrencode is installed: rpm -qa | grep qrencode
  - Terminal must support UTF-8

Problem: "sudo" not working after setup
  - You probably changed auth_type in /etc/security/login.cfg
  - Change it back to STD_AUTH (NOT PAM_AUTH)

VERSION
-------
Documentation version: 1.9 (January 2026)

================================================================================
  SIXE - IBM Business Partner | https://sixe.eu
  LibrePower | https://librepower.org
================================================================================
