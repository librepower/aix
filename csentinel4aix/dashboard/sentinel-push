#!/bin/bash
#
# sentinel-push - Send sentinel fingerprint to dashboard
#
# Usage: sentinel-push [options]
#
# Runs sentinel and POSTs the JSON output to the configured dashboard.
# Designed for AIX - uses short options only.
#

set -e

# Configuration - override with environment variables
SENTINEL_BIN="${SENTINEL_BIN:-/opt/freeware/bin/sentinel}"
CURL_BIN="${CURL_BIN:-/opt/freeware/bin/curl}"
DASHBOARD_URL="${DASHBOARD_URL:-http://localhost:5000/api/ingest}"
API_KEY="${SENTINEL_API_KEY:-}"

# Default sentinel arguments (AIX short options)
SENTINEL_ARGS="-j -n"

usage() {
    echo "Usage: $0 [options]"
    echo
    echo "Runs sentinel and sends the fingerprint to the dashboard."
    echo
    echo "Options:"
    echo "  -u URL    Dashboard URL (default: \$DASHBOARD_URL)"
    echo "  -k KEY    API key (default: \$SENTINEL_API_KEY)"
    echo "  -a        Include audit data (-a flag)"
    echo "  -b        Include baseline comparison (-b flag)"
    echo "  -v        Verbose output"
    echo "  -h        Show this help"
    echo
    echo "Environment variables:"
    echo "  DASHBOARD_URL      Dashboard API endpoint"
    echo "  SENTINEL_API_KEY   API key for authentication"
    echo "  SENTINEL_BIN       Path to sentinel binary"
    echo
    echo "Example:"
    echo "  $0 -u http://dashboard:5000/api/ingest -k myapikey"
    echo
    echo "Crontab example (every 5 minutes):"
    echo "  */5 * * * * SENTINEL_API_KEY=mykey DASHBOARD_URL=http://host:5000/api/ingest /opt/freeware/bin/sentinel-push"
    echo
    exit 1
}

VERBOSE=0

# Parse arguments (AIX-compatible - short options only)
while getopts "u:k:abvh" opt; do
    case $opt in
        u)
            DASHBOARD_URL="$OPTARG"
            ;;
        k)
            API_KEY="$OPTARG"
            ;;
        a)
            SENTINEL_ARGS="$SENTINEL_ARGS -a"
            ;;
        b)
            SENTINEL_ARGS="$SENTINEL_ARGS -b"
            ;;
        v)
            VERBOSE=1
            ;;
        h)
            usage
            ;;
        *)
            usage
            ;;
    esac
done

# Check requirements
if [ -z "$API_KEY" ]; then
    echo "Error: API key required. Set SENTINEL_API_KEY or use -k option."
    exit 1
fi

if [ ! -x "$SENTINEL_BIN" ]; then
    echo "Error: Sentinel binary not found at $SENTINEL_BIN"
    echo "Install with: dnf install csentinel4aix"
    exit 1
fi

if [ ! -x "$CURL_BIN" ]; then
    # Try system curl
    CURL_BIN="curl"
    if ! command -v curl >/dev/null 2>&1; then
        echo "Error: curl not found"
        exit 1
    fi
fi

# Run sentinel and capture output
if [ $VERBOSE -eq 1 ]; then
    echo "Running: $SENTINEL_BIN $SENTINEL_ARGS"
fi

OUTPUT=$("$SENTINEL_BIN" $SENTINEL_ARGS 2>/dev/null)
EXIT_CODE=$?

if [ $VERBOSE -eq 1 ]; then
    echo "Sentinel exit code: $EXIT_CODE"
    echo "Sending to: $DASHBOARD_URL"
fi

# Send to dashboard
RESPONSE=$(echo "$OUTPUT" | "$CURL_BIN" -s -X POST \
    -H "Content-Type: application/json" \
    -H "X-API-Key: $API_KEY" \
    -H "X-Exit-Code: $EXIT_CODE" \
    -d @- \
    "$DASHBOARD_URL" 2>&1)

if [ $VERBOSE -eq 1 ]; then
    echo "Response: $RESPONSE"
fi

# Check response
if echo "$RESPONSE" | grep -q '"status"'; then
    if echo "$RESPONSE" | grep -q '"ok"'; then
        [ $VERBOSE -eq 1 ] && echo "Successfully sent fingerprint"
        exit 0
    fi
fi

echo "Failed to send fingerprint: $RESPONSE"
exit 1
